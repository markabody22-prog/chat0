<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Butterfly Garden Chat</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <style>
        :root {
            --garden-green: #7fb069;
            --soft-pink: #ffc0cb;
            --sky-blue: #e1f5fe;
            --flower-purple: #9575cd;
            --dark-green: #2e7d32;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--sky-blue);
            background-image: linear-gradient(rgba(255,255,255,0.5), rgba(255,255,255,0.5)), url('https://www.transparenttextures.com/patterns/floral-paper.png');
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        #header {
            background-color: var(--garden-green);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.4rem;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-bottom: 4px solid var(--soft-pink);
        }

        /* Chat Window */
        #chat-window {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message-container {
            display: flex;
            flex-direction: column;
            max-width: 80%;
            position: relative;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

        .mine { align-self: flex-start; }
        .others { align-self: flex-end; }

        .msg-bubble {
            padding: 12px 15px;
            border-radius: 20px;
            font-size: 15px;
            color: #333;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .mine .msg-bubble { background-color: white; border: 2px solid var(--soft-pink); border-bottom-left-radius: 2px; }
        .others .msg-bubble { background-color: var(--garden-green); color: white; border-bottom-right-radius: 2px; }

        .user-name { font-size: 11px; margin-bottom: 4px; font-weight: bold; color: var(--dark-green); }
        .others .user-name { text-align: left; color: var(--flower-purple); }

        /* Delete Button */
        .delete-btn {
            background: none;
            border: none;
            color: #ff5252;
            font-size: 18px;
            cursor: pointer;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: none;
        }

        .mine .delete-btn { right: -30px; display: block; }

        /* Input Bar */
        #input-area {
            background: white;
            padding: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-top: 2px solid var(--garden-green);
        }

        input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 25px;
            border: 2px solid #ddd;
            outline: none;
            transition: 0.3s;
        }

        input:focus { border-color: var(--garden-green); }

        button#send-btn {
            background-color: var(--flower-purple);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        button#send-btn:hover { background-color: var(--dark-green); }

    </style>
</head>
<body>

<div id="header">ü¶ã Butterfly Garden üå∏</div>

<div id="chat-window"></div>

<div id="input-area">
    <input type="text" id="msgInput" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ© ÿ±ŸÇŸäŸÇÿ©...">
    <button id="send-btn">‚û§</button>
</div>

<script>
    // Initialize GunDB
    const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
    const chatRoom = gun.get('butterfly_garden_v2'); 

    const chatWindow = document.getElementById('chat-window');
    const input = document.getElementById('msgInput');
    const sendBtn = document.getElementById('send-btn');

    const myId = "user_" + Math.random().toString(36).substr(2, 9);
    const myName = "ŸÅÿ±ÿßÿ¥ÿ©_" + Math.floor(Math.random() * 999);

    // Send Message
    sendBtn.onclick = () => {
        const text = input.value.trim();
        if (text) {
            const messageId = Date.now().toString();
            chatRoom.get(messageId).put({
                id: messageId,
                senderId: myId,
                user: myName,
                text: text,
                deleted: false
            });
            input.value = '';
        }
    };

    // Receive and Sync Messages
    chatRoom.map().on((data, id) => {
        if (!data) return;

        let existingMsg = document.getElementById(id);

        // If message is marked as deleted, remove it from UI
        if (data.deleted) {
            if (existingMsg) existingMsg.remove();
            return;
        }

        if (data.text && !existingMsg) {
            const isMine = data.senderId === myId;
            const container = document.createElement('div');
            container.id = id;
            container.className = `message-container ${isMine ? 'mine' : 'others'}`;

            container.innerHTML = `
                <span class="user-name">${data.user}</span>
                <div class="msg-bubble">${data.text}</div>
                ${isMine ? `<button class="delete-btn" onclick="deleteMessage('${id}')">üóëÔ∏è</button>` : ''}
            `;

            chatWindow.appendChild(container);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    });

    // Delete Message function
    window.deleteMessage = (id) => {
        chatRoom.get(id).put({ deleted: true });
    };

    input.onkeydown = (e) => { if(e.key === 'Enter') sendBtn.click(); };
</script>

</body>
</html>