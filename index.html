<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Butterfly Garden - Accounts</title>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        :root { --primary: #7fb069; --me-bg: #dcf8c6; --bg: #e5ddd5; --accent: #9575cd; }
        * { box-sizing: border-box; font-family: sans-serif; }
        body { margin: 0; background: #f0f2f5; height: 100vh; overflow: hidden; }

        /* Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„ */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1000; color: white; padding: 20px;
        }
        .auth-card { background: white; padding: 25px; border-radius: 15px; width: 100%; max-width: 320px; color: #333; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .auth-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; outline: none; text-align: center; font-size: 16px; }
        .auth-card button { width: 100%; padding: 12px; border: none; background: var(--primary); color: white; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .auth-card p { font-size: 12px; color: #666; text-align: center; cursor: pointer; text-decoration: underline; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
        #main-app { display: none; flex-direction: column; height: 100vh; }
        header { background: var(--primary); color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: var(--bg); background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        
        .bubble { max-width: 85%; padding: 8px 12px; border-radius: 12px; font-size: 15px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .mine { align-self: flex-start; background: white; border-top-left-radius: 0; }
        .others { align-self: flex-end; background: var(--me-bg); border-top-right-radius: 0; }
        .sender { font-size: 11px; font-weight: bold; color: var(--accent); display: block; margin-bottom: 3px; }
        .msg-footer { display: flex; align-items: center; justify-content: space-between; margin-top: 5px; font-size: 10px; color: #888; }
        .del-btn { background: none; border: none; cursor: pointer; color: #ff5252; font-size: 14px; }

        .input-bar { background: #f0f0f0; padding: 8px 10px; display: flex; align-items: flex-end; gap: 5px; border-top: 1px solid #ddd; }
        .input-wrapper { flex: 1; background: white; border-radius: 25px; padding: 5px 10px; display: flex; align-items: center; border: 1px solid #ccc; }
        #msgInput { flex: 1; border: none; outline: none; padding: 8px; max-height: 80px; resize: none; font-size: 16px; }
        #sendBtn { background: var(--primary); color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; flex-shrink: 0; }
        
        #emoji-panel { display: none; background: white; grid-template-columns: repeat(8, 1fr); padding: 10px; max-height: 150px; overflow-y: auto; }
        .emoji { font-size: 24px; padding: 5px; cursor: pointer; text-align: center; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card" id="login-box">
            <h3 style="text-align:center; margin-top:0;">ğŸ¦‹ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø©</h3>
            <input type="text" id="user-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="user-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="handleAuth()">Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„</button>
            <p style="margin-top:15px;">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ ÙƒÙ†Øª Ø¬Ø¯ÙŠØ¯Ø§Ù‹ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
        </div>
    </div>

    <div id="main-app">
        <header>
            <span id="display-name">...</span>
            <span>ğŸ¦‹ Butterfly Garden</span>
            <button onclick="logout()" style="background:none; border:none; color:white; font-size:12px;">Ø®Ø±ÙˆØ¬</button>
        </header>
        <div id="chat-window"></div>
        <div id="emoji-panel"></div>
        <div class="input-bar">
            <button style="background:none; border:none; font-size:22px;" onclick="toggleEmoji()">ğŸ˜Š</button>
            <label style="font-size:22px; cursor:pointer;">ğŸ“<input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleImage(event)"></label>
            <div class="input-wrapper">
                <textarea id="msgInput" rows="1" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
            </div>
            <button id="sendBtn" onclick="send()">â¤</button>
        </div>
    </div>

<script>
    const API_KEY = 'XGo5cg.HJoQoA:tgdISgIHM4HJKMf3-H1Zh4dpouEoCR-zyunHiWVlq7E';
    let ably, channel, currentUser = null;

    // Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¨Ø³Ø·
    function handleAuth() {
        const name = document.getElementById('user-name').value.trim();
        const pass = document.getElementById('user-pass').value.trim();

        if (name.length < 3 || pass !== "4444") { // Ø¬Ø¹Ù„Øª ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ØºØ±ÙØ© Ù‡ÙŠ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹
            alert("ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ø³Ù… ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ØºØ±ÙØ© (4444)");
            return;
        }

        currentUser = { name: name, id: btoa(name) }; // Ø¥Ù†Ø´Ø§Ø¡ ID ÙØ±ÙŠØ¯ Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù…
        localStorage.setItem('butterfly_user', JSON.stringify(currentUser));
        startApp();
    }

    function startApp() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        document.getElementById('display-name').innerText = currentUser.name;

        ably = new Ably.Realtime(API_KEY);
        channel = ably.channels.get('butterfly-v10-accounts');

        // Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        channel.history({ limit: 30 }, (err, page) => {
            if (page) page.items.reverse().forEach(m => displayMessage(m.data));
        });

        channel.subscribe('msg', (m) => {
            if(m.data.type === 'delete') {
                document.getElementById(m.data.id)?.remove();
            } else {
                displayMessage(m.data);
            }
        });
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function send() {
        const txt = document.getElementById('msgInput').value.trim();
        if(!txt && !compressedImage) return;

        const msgId = "id_" + Date.now() + "_" + currentUser.id;
        channel.publish('msg', {
            id: msgId,
            senderId: currentUser.id,
            user: currentUser.name,
            text: txt,
            image: compressedImage,
            type: 'new'
        });

        document.getElementById('msgInput').value = '';
        compressedImage = null;
    }

    function displayMessage(data) {
        if(!data.id || document.getElementById(data.id)) return;
        const isMe = data.senderId === currentUser.id;
        const div = document.createElement('div');
        div.id = data.id;
        div.className = `bubble ${isMe ? 'mine' : 'others'}`;
        
        div.innerHTML = `
            <span class="sender">${data.user}</span>
            ${data.image ? `<img src="${data.image}" style="max-width:100%; border-radius:8px;">` : ''}
            <div>${data.text || ''}</div>
            <div class="msg-footer">
                <span>${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                ${isMe ? `<button class="del-btn" onclick="requestDelete('${data.id}')">ğŸ—‘ï¸</button>` : ''}
            </div>
        `;
        document.getElementById('chat-window').appendChild(div);
        document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
    }

    function requestDelete(id) {
        if(confirm("Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ØŸ")) channel.publish('msg', { id: id, type: 'delete' });
    }

    function logout() {
        localStorage.removeItem('butterfly_user');
        location.reload();
    }

    // Ø¶ØºØ· Ø§Ù„ØµÙˆØ± (Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ù…Ù„)
    let compressedImage = null;
    function handleImage(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 400;
                canvas.width = MAX_WIDTH; canvas.height = img.height * (MAX_WIDTH / img.width);
                canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                compressedImage = canvas.toDataURL('image/jpeg', 0.5);
                alert("Ø§Ù„ØµÙˆØ±Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„!");
            };
        };
    }

    // Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
    const emojis = ["ğŸ˜Š","ğŸ˜‚","â¤ï¸","ğŸ˜","ğŸ‘","âœ¨","ğŸ¦‹","ğŸŒ¸","ğŸ®","ğŸ’”"];
    emojis.forEach(e => {
        let span = document.createElement('span'); span.className = 'emoji'; span.innerText = e;
        span.onclick = () => { document.getElementById('msgInput').value += e; };
        document.getElementById('emoji-panel').appendChild(span);
    });
    function toggleEmoji() { const p = document.getElementById('emoji-panel'); p.style.display = p.style.display === 'grid' ? 'none' : 'grid'; }

    // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø¬Ù„Ø§Ù‹ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø³Ø¨Ù‚Ø§Ù‹
    const savedUser = localStorage.getItem('butterfly_user');
    if(savedUser) {
        currentUser = JSON.parse(savedUser);
        startApp();
    }
</script>
</body>
</html>
